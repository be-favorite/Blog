---
title: "í†µê³„ì‹¤ìŠµ III. ë§¤ì¹­"
subtitle: "ê°€ì²œëŒ€ ê¸¸ë³‘ì› ê³ ê¸‰í†µê³„êµìœ¡"
author: "ë°©íƒœëª¨"
institute: "ê°€ì²œëŒ€ ê¸¸ë³‘ì› ì¸ê³µì§€ëŠ¥ë¹…ë°ì´í„°ìœµí•©ì„¼í„°"
date: "2022-06-28"
output:
  xaringan::moon_reader:
    css: 
      - default
      - css/statisticsplaybook.css
      - css/statisticsplaybook-fonts.css
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: googlecode
      highlightLines: true
      highlightLanguage: ["r"]
      countIncrementalSlides: false
      ratio: "16:9"
      navigation:
          scroll: false # disable slide transitions by scrolling
    includes:
      in_header: "assets/mathjax-equation-numbers.html"
      after_body: [css/insert-logo.html]
---

```{r setup, include = FALSE}
library(knitr)
library(rmarkdown)
xaringanExtra::use_panelset()
xaringanExtra::use_clipboard()
# set default options
opts_chunk$set(dpi = 300)
```

class: title-slide, left, bottom

# `r rmarkdown::metadata$title`
----
## **`r rmarkdown::metadata$subtitle`**
### `r rmarkdown::metadata$author`
### `r rmarkdown::metadata$date`

---

# .brand-blue[ëª©ì°¨]

.pull-left[
 - .content-box-blue[ì„œë¡ ]
 
   - ìƒê´€ê´€ê³„ì™€ ì¸ê³¼ê´€ê³„
   
   - ì¸ê³¼ì¶”ë¡ ì˜ ì¡°ê±´
   
   - RCTì™€ RWE
   
   - í˜¼ë€ë³€ìˆ˜ë¥¼ í†µì œí•˜ëŠ” ë°©ë²•
   
  
  - .content-box-blue[Propensity score]
  
]

.pull-right[

 - .content-box-blue[PS matching method]
   
   - Nearest neighbor matching
   
   - Optimal matching
    
   - Full matching
 
 
 - .content-box-blue[Weighting]
 
   - IPTW
 
   - Matchingê³¼ Weighting
 
 
- .content-box-blue[Balance diagnostics]
 
 
 - .content-box-blue[ì‹¤ìŠµ]

]
 
---

class: inverse, middle, center

# ì„œë¡ 

---

## .brand-blue[ìƒê´€ê´€ê³„ì™€ ì¸ê³¼ê´€ê³„]

- ìƒê´€(Correlation): ë‘˜ ì´ìƒì˜ ë³€ì¸ ê°„ì˜ ê´€ë ¨

  - ì•„ì´ìŠ¤í¬ë¦¼ íŒë§¤ëŸ‰ê³¼ ìµì‚¬ ì‚¬ê³  ê±´ìˆ˜ ê°„ì—ëŠ” ìƒê´€ì´ ì¡´ì¬
  
  - ì¦‰, ì•„ì´ìŠ¤í¬ë¦¼ íŒë§¤ëŸ‰( $x$ )ì´ ìµì‚¬ ì‚¬ê³  ê±´ìˆ˜( $y$ )ì˜ ì˜ˆì¸¡ì— ìœ ìš©í•  ìˆœ ìˆìŒì„ ëœ»í•¨
  
  - ë‹¤ë§Œ, $x$ê°€ $y$ì˜ ì›ì¸ì´ ëœë‹¤ëŠ” ê²ƒì€ ì•„ë‹˜
  
  - ê·¸ë ‡ë‹¤ë©´ ì´ëŸ¬í•œ ìƒê´€ì´ ì¡´ì¬í•˜ëŠ” ì›ì¸ì€?
  
  - í˜¼ë€ë³€ìˆ˜(Confounder)ì˜ ì¡´ì¬: ë°˜ì‘ë³€ìˆ˜ì™€ ì ì–´ë„ í•˜ë‚˜ ì´ìƒì˜ ì˜ˆì¸¡ë³€ìˆ˜ì— ì˜í–¥ì„ ë¯¸ì¹¨

- ì¸ê³¼(Causation): ì›ì¸ê³¼ ê²°ê³¼

  - ë¹„ ì˜ˆë³´ê°€ ìˆëŠ” ê²½ìš°, ì•„ì¹¨ì— ìì „ê±°ë¥¼ íƒ€ëŠ” ì‚¬ëŒë“¤ì´ ì¤„ì–´ë“¦
  
  - ì¦‰, ê°•ìš°( $x$, ì›ì¸)ê°€ ìì „ê±° íƒ€ëŠ” ì‚¬ëŒ( $y$, ê²°ê³¼)ì— ì˜í–¥ì„ ë¯¸ì¹¨
  
  - ì¸ê³¼ê´€ê³„ë¥¼ í†µí•´ ë³´ë‹¤ ë” ë‚˜ì€ ëª¨ë¸ì„ ë§Œë“¤ ìˆ˜ ìˆìŒ

---

## .brand-blue[ì¸ê³¼ì¶”ë¡ ì˜ ì¡°ê±´]

### .black[1 ì‹œê°„ì  ìš°ì„ ì„±]

- ì›ì¸ì´ ê²°ê³¼ë³´ë‹¤ ì‹œê°„ìƒìœ¼ë¡œ ë¨¼ì € ë°œìƒí•´ì•¼ í•¨

### .black[2 ê³µë³€ì„±(ìƒê´€ê´€ê³„)]

- ì›ì¸ì´ ë³€í™”í•˜ë©´ ê²°ê³¼ë„ í•­ìƒ ê°™ì´ ë³€í™”í•´ì•¼ í•¨

### .black[3 í†µì œì„±]

- ì›ì¸ê³¼ ê²°ê³¼ê°€ ì œ 3ì˜ ë³€ìˆ˜(í˜¼ë€ë³€ìˆ˜, Confounder)ì— ì˜í–¥ì„ ë°›ì•„ì„œëŠ” ì•ˆë¨

<br>


<center>

<blockquote> .black[_ë¬´ì‘ìœ„ë°°ì •ì„ ê±°ì¹˜ì§€ ì•ŠëŠ” ê´€ì¸¡ì—°êµ¬ëŠ” "í†µì œì„±"ì„ ë§Œì¡±ì‹œí‚¤ê¸° ì–´ë ¤ì›€_] </blockquote>

</center>

---

## .brand-blue[RCTì™€ RWE]

.pull-left[

- RCT ì—°êµ¬

  - ëª¨ì§‘ë‹¨(ì™¼ìª½)ì—ì„œ ëœë¤ìœ¼ë¡œ ê° êµ°ì— 10ëª…ì”© í• ë‹¹
  
  - ì¼ì • ì—°êµ¬ ê¸°ê°„ì´ ì§€ë‚œ í›„ ë…ê° ë°œìƒë¥  ê³„ì‚°

- ëª©ì : ë°±ì‹ ê³¼ ë…ê° ë°œìƒì˜ ê´€ê³„ í™•ì¸

- êµ°ê°„ ë…ê° ë°œìƒë¥  ì°¨ì´ = 0.4

]

.pull-right[
```{r RCT, echo = FALSE, out.height = 300, fig.cap = "fig 1. RCT (Linewalk's Blog)"}
knitr::include_graphics("./fig/RCT.png")
```

]

---

## .brand-blue[RCTì™€ RWE]

.pull-left[

- RWE(Real world evidence): ê´€ì°° ë°ì´í„°ë¥¼ ì´ìš©í•œ í›„í–¥ì  ì—°êµ¬

  - ë°±ì‹  íˆ¬ì—¬ êµ°ê³¼ ë¹„ íˆ¬ì—¬êµ°ì„ ì‹¤í—˜êµ°, ëŒ€ì¡°êµ° ê° êµ°ìœ¼ë¡œ ë‚˜ëˆ” 
  
  - ê° êµ°ì—ì„œ ë…ê° ë°œìƒë¥  ê³„ì‚°

- êµ°ê°„ ë…ê° ë°œìƒë¥  ì°¨ì´ = 0.12

- ì„ íƒ í¸ì˜(selection bias) ë°œìƒ
  
  - ë…¸ë ¹ì¸µê³¼ ì˜ìœ ì•„ì¸µì˜ ë°±ì‹  íˆ¬ì—¬ìœ¨ì´ ë†’ìŒ
  
  - ì„±ë³„ê³¼ ë‚˜ì´ê°€ í˜¼ë€ë³€ìˆ˜ê°€ ë¨
  
  - ë¬´ì‘ìœ„ ë°°ì •ì— ì˜í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì–´ë–¤ í˜„ìƒì˜ ì›ì¸ ì¶”ë¡ ì´ ë¶ˆê°€ëŠ¥

]

.pull-right[

```{r RWE, echo = FALSE, out.height = 300, fig.cap = "fig 2. RWE (Linewalk's Blog)"}
knitr::include_graphics("./fig/RWE.png")
```  

]

---

## .brand-blue[í˜¼ë€ë³€ìˆ˜ë¥¼ í†µì œí•˜ëŠ” ë°©ë²•]

.left-column[

```{r confounder, echo = FALSE, out.height = 200, fig.cap = "fig 3. Confounder (Linewalk's Blog)", fig.align = "center"}
knitr::include_graphics("./fig/confounder.png")
```

]
.right-column[

 - Causal effect 
 
 \begin{align}
  E(Y(1)) - E(Y(0)) = E(Y|T = 1) - E(Y|T=0)
 \end{align}
 
 
 - ê´€ì°°ì—°êµ¬ì—ì„œëŠ” í˜¼ë€ë³€ìˆ˜( $X$ )ì— ì˜í•´ ìœ„ ë“±ì‹ì´ ì„±ë¦½í•˜ì§€ ì•ŠìŒ
 
   - $T=0$ì¼ë•Œ $X$ì˜ ë¶„í¬ì™€ $T=1$ì¼ë•Œ $X$ì˜ ë¶„í¬ê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸
 
 - Matching, Weightingì„ í†µí•´ í•´ê²° ê°€ëŠ¥
 
   - ê´€ì°°ì—°êµ¬ì—ì„œ ì„ íƒí¸í–¥ì„ ê°ì†Œì‹œí‚¤ëŠ” ë°©ë²•ë¡ 
   
   - How? ì‹¤í—˜êµ°ê³¼ ëŒ€ì¡°êµ°ì´ ë™ì¼í•œ $X$ì˜ ë¶„í¬ë¥¼ ê°–ê²Œë” í•¨ìœ¼ë¡œì¨
   
  - ê·¸ëŸ¬ë‚˜, ë§ì€ ë¬¸ì œì—ì„œ ë³€ìˆ˜ë¥¼ ì§ì ‘ ë§¤ì¹­í•˜ëŠ” ê²ƒì€ ì–´ë ¤ì›€ (íŠ¹íˆ ì—°ì†í˜• ë³€ìˆ˜)
  
      - Propensity scoreë¡œ ë§¤ì¹­í•˜ëŠ” ê²ƒìœ¼ë¡œ ì¶©ë¶„ (Rosenbaum and Rubin, 1983) 

]

---

class: inverse, middle, center

# Propensity score

---
## .brand.blue[Propensity score]

- ê³ ì „ì ì¸ ë§¤ì¹­ ë°©ë²•ì´ ê°–ëŠ” ë‹¨ì ì„ ê·¹ë³µí•˜ê³  ì„ íƒí¸í–¥ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì¸¡ë„

- ë¡œì§€ìŠ¤í‹± íšŒê·€ëª¨í˜•ì„ í†µí•´ ì¶”ì •

\begin{align}
\pi = {\rm{Pr}}(Y = 1 | X = x) = \frac{e^{\beta_0 + \beta_1x}}{1 + e^{\beta_0 + \beta_1x}}
\end{align}

- ì—¬ê¸°ì„œ $Y$ëŠ” ì²˜ë¦¬(treatment), $X$ëŠ” í˜¼ë€ë³€ìˆ˜ê°€ ë¨

- ì¦‰, propensity scoreëŠ” ì—°êµ¬ ëŒ€ìƒì´ í˜¼ë€ë³€ìˆ˜ì— ì˜í•´ ì‹¤í—˜êµ°ì— í¬í•¨ë  í™•ë¥ ì„ ì˜ë¯¸

- Matching:PS(propensity score)ê°€ ê°™ì€ í˜¹ì€ ìœ ì‚¬í•œ ëŒ€ìƒë¼ë¦¬ ì§ì„ ë§ì¶”ì–´ ìë£Œ ì„ ì •

  - .blue[Key idea]: PSì˜ ì°¨ì´ê°€ ì‘ì€ ëŒ€ìƒë“¤ë¼ë¦¬ ë§¤ì¹­

  - ì§ì„ ì´ë£¨ì§€ ëª»í•˜ë©´ ì œì™¸
  
- Weighting: PSê°€ ì‘ì€ ëŒ€ìƒì— ëŒ€í•´ ì—­ê°€ì¤‘(IPTW)ì„ ì¤Œìœ¼ë¡œì¨ ë‘ êµ°ê°„ í˜¼ë€ë³€ìˆ˜ì˜ ë¶„í¬ë¥¼ ë§ì¶°ì¤Œ

---

class: inverse, middle, center

# Propensity score matching method

---
## .brand.blue[Nearest neighbor]

.pull-left[
 - í•˜ë‚˜ì˜ ì‹¤í—˜êµ° ëŒ€ìƒê³¼ ëŒ€ì¡°êµ°ì˜ ëª¨ë“  ëŒ€ìƒ ê°„ PSì˜ ì°¨ì´ê°€ ì‘ì€ ìˆœìœ¼ë¡œ ë§¤ì¹­

- ê°€ì¥ ë§ì´ í™œìš©ë˜ëŠ” ë§¤ì¹­ ë°©ë²•

- Greedy matching ë°©ë²•ë¡  ì¤‘ í•˜ë‚˜ì— í•´ë‹¹

  - ìˆœê°„ì— ìµœì ì´ë¼ê³  ìƒê°ë˜ëŠ” ê²ƒì„ ì„ íƒí•´ ë‚˜ê°€ëŠ” ë°©ì‹
  
  - ì‹¤í—˜êµ° ì¤‘ ì–´ë–¤ ëŒ€ìƒë¶€í„° ë§¤ì¹­ì„ ì‹œì‘í•˜ëŠëƒì— ë”°ë¼ ë§¤ì¹­ì˜ ì§ˆì´ ì¡°ê¸ˆ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ
]

.pull-right[
 - ì£¼ìš” ì˜µì…˜

  - ë°˜ë³µ ë§¤ì¹­: ëŒ€ì¡°êµ°ì˜ í‘œë³¸ ìˆ˜ê°€ ì‘ì€ ê²½ìš° ì—¬ëŸ¬ ì‹¤í—˜êµ°ê³¼ ì¤‘ë³µí•˜ì—¬ ë§¤ì¹­ë˜ëŠ” ëŒ€ì¡°êµ° í—ˆìš©
  
  - ì •í™• ë§¤ì¹­: ì¼ë¶€ ì„¤ëª… ë³€ìˆ˜ì— ëŒ€í•´ ì •í™• ë§¤ì¹­ì„ ë¨¼ì € ì‹œí–‰í•œ í›„, ì„ íƒëœ ëŒ€ìƒë“¤ ì‚¬ì´ì—ì„œ nearest matching ì‹œí–‰
  
  <!-- ì˜ˆë¥¼ ë“¤ë©´ ì¸ì¢…ê³¼ ê°™ì´ ì •í™•íˆ ë§¤ì¹­í•´ì•¼í•˜ëŠ” ë³€ìˆ˜ -->
  
  - ìº˜ë¦¬í¼: ì¶”ì •ëœ PSì˜ í‘œì¤€ì˜¤ì°¨ì˜ $k$ë°° ë²”ìœ„ì— ì¡´ì¬í•˜ëŠ” ëŒ€ìƒë§Œ ë§¤ì¹­ì— ê³ ë ¤
  
  - ëŒ€ì¡°/ì‹¤í—˜êµ° ë¹„: ëŒ€ì¡°êµ°ì´ ì‹¤í—˜êµ°ì— ë¹„í•´ ë§ì€ ê²½ìš° 1:N ë§¤ì¹­ì„ í†µí•´ ì „ì²´ í‘œë³¸ ìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆìŒ

<!-- 1:Nì€ í•˜ë‚˜ì˜ ì‹¤í—˜êµ°ì„ ë¹„ìŠ·í•œ ì„±í–¥ì„ ê°€ì§„ ì—¬ëŸ¬ê°œì˜ ëŒ€ì¡°êµ°ê³¼ ë§¤ì¹­ -> ëŒ€ì¡°êµ° í‘œë³¸ì´ ë§ì€ ê²½ìš°ê°€ -->

]

---
## .brand.blue[Optimal matching]

- ëª¨ë“  ë§¤ì¹­ëœ ì§ì˜ ê±°ë¦¬ê°€ ìµœì†Œê°€ ë˜ë„ë¡ ë§¤ì¹­

- Non-greedy matching ë°©ë²•ë¡  ì¤‘ í•˜ë‚˜

- 1:N ë§¤ì¹­ ê°€ëŠ¥

## .brand.blue[Full matching]

- N:N ë§¤ì¹­

- 1:Nê³¼ N:1 ëª¨ë‘ ì‚¬ìš©í•˜ì—¬ ë§¤ì¹­ ì…‹ì„ ë§Œë“¦

- Non-greedy matching ë°©ë²•ë¡  ì¤‘ í•˜ë‚˜

---

class: inverse, middle, center

# Weighting

---

## .brand.blue[IPTW: Inverse Probability of Treatment Weighting]

.pull-left[
- Weighting: í˜¼ë€ë³€ìˆ˜ì˜ íš¨ê³¼ë¥¼ í†µì œí•  ìˆ˜ ìˆëŠ” ë˜ í•˜ë‚˜ì˜ ë°©ë²•
  
- IPTWëŠ” ì¶”ì •ëœ PSì˜ ì—­ìˆ˜ë¥¼ ê°€ì¤‘ì¹˜ë¡œ ë¶€ì—¬í•˜ì—¬ í˜¼ë€ë³€ìˆ˜ì˜ ì˜í–¥ì„ ìµœì†Œí™”í•¨

- ë‹¤ìŒì˜ ê·¸ë¦¼ì€ IPTWì˜ ì•„ì´ë””ì–´ë¥¼ ê°€ì¥ ê°„ë‹¨í•˜ê³  ì§ê´€ì ìœ¼ë¡œ ì„¤ëª…í•´ ì¤Œ

  - ê° êµ°ì— ì„±ì¸ë‚¨ì„±ì´ Unbalancedí•˜ê²Œ ì¡´ì¬
  
  - ì¶”ì •ëœ PSì˜ ì—­ìˆ˜ë¥¼ ì´ìš©í•´ ê°€ì¤‘ëœ ìƒ˜í”Œì„ ìƒì„±
  
  - ì´ ê°€ì¤‘ëœ ìƒ˜í”Œì„ Pseudo-population(ê°€ìƒì˜ ëª¨ì§‘ë‹¨)ì´ë¼í•˜ë©°, ì´ë¥¼ í†µí•´ ë¶„ì„ì„ ì§„í–‰í•¨

]

.pull-right[
```{r IPTW, echo = FALSE, out.height = 500, fig.cap = "fig 7. IPTW (Ehud Karavani)"}
knitr::include_graphics("./fig/iptw.jpeg")
```
]

---

## .brand.blue[ë§¤ì¹­ê³¼ Weighting]

.pull-left[

### .black[ë§¤ì¹­]

- ì¥ì 

  - ì§ê´€ì 
  
  - balanced checkê°€ ì–´ë µì§€ ì•ŠìŒ
  
- ë‹¨ì 

  - ë§¤ì¹­ë˜ì§€ ì•Šì€ í‘œë³¸ì€ ë²„ë¦¬ê²Œë˜ì–´ í‘œë³¸ ìˆ˜ê°€ ì¤„ì–´ë“¦
  
  - ì´ì—ë”°ë¼, ì›ìë£Œì™€ Matched sampleì—ì„œ íŠ¹ì„±ì´ í¬ê²Œ ë‹¬ë¼ì§€ë©´, ì›ìë£Œì˜ ì²˜ë¦¬íš¨ê³¼ì™€ Matched sampleì˜ ì²˜ë¦¬íš¨ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ

]

.pull-right[

### .black[Weighting]

- ì¥ì  

  - ê°€ì¤‘ì¹˜ë¥¼ ì¤˜ì„œ Pseudo-populationì„ í†µí•´ ë¶„ì„ì„ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì— ì› ìë£Œë¥¼ ëª¨ë‘ í™œìš©í•  ìˆ˜ ìˆìŒ

  - balaced checkê°€ ì–´ë µì§€ ì•ŠìŒ
  
- ë‹¨ì 

  - PSM ë˜í•œ ì¶”ì •ëœ PSì˜ ì •í™•ì„±ì— ë¯¼ê°í•˜ë‚˜, Weightingì€ ë§¤ì¹­ì— ë¹„í•´ PSì˜ ì¶”ì •ì˜ ì •í™•ì„±ì— í›¨ì”¬ ë¯¼ê°í•¨
  
  - ë”°ë¼ì„œ, PS ì¶”ì •ì˜ ì •í™•ì„±ì— í™•ì‹ ì´ ì—†ìœ¼ë©´ ì„ íƒí•´ì„œëŠ” ì•ˆë˜ëŠ” ë°©ë²•

<!-- ê·¸ë˜ì„œ, ì¼ë°˜ì ìœ¼ë¡œ ë§¤ì¹­ì„ ê°€ì¥ ì²« ë²ˆì§¸ë¡œ ê³ ë ¤í•  ìˆ˜ ìˆê³  ê·¸ ë‹¤ìŒìœ¼ë¡œ ê³ ë ¤í•˜ëŠ” ê²ƒì´ Weighting -->

]


---

class: inverse, middle, center

# Balance diagnostics

---

.pull-left[

## .brand.blue[SMD]

- SMD: Standardized mean difference

- ê° í˜¼ë€ë³€ìˆ˜ì—ì„œ ë‘ ì§‘ë‹¨ ê°„ ì°¨ì´ê°€ ì¡´ì¬í•˜ëŠ”ê°€?

\begin{align}
d_{continuous} = \frac{\bar{x}_{trt} - \bar{x}_{con}}{\sqrt{\frac{s^2_{trt} + s^2_{con}}{2}}}
\end{align}
\begin{align}
d_{categorical} = \frac{\hat{p}_{trt} - \hat{p}_{con}}{\sqrt{\frac{s^2_{trt} + s^2_{con}}{2}}}
\end{align}

- ë§¤ì¹­ ì „ê³¼ ë§¤ì¹­ í›„ SMD ë¹„êµ

- ë§¤ì¹­ í›„ SMDê°€ 0.1 ì´í•˜ì´ë©´ ë³´í†µ ë§¤ì¹­ì´ ì˜ ì´ë£¨ì–´ì¡Œë‹¤ê³  íŒë‹¨

]

.pull-right[
 
## .brand.blue[QQplot]

- ê° í˜¼ë€ë³€ìˆ˜ë³„ QQplotì„ í†µí•´ balanceë¥¼ ì²´í¬í•  ìˆ˜ ìˆìŒ

- $x$ì¶•ì€ ëŒ€ì¡°êµ°ì˜ í˜¼ë€ë³€ìˆ˜ ë¶„í¬, $y$ ì¶•ì€ ì‹¤í—˜êµ°ì˜ í˜¼ë€ë³€ìˆ˜ ë¶„í¬ê°€ ë¨

- ì§ì„ ì— ì˜ ë‚˜ì—´ë˜ì–´ ìˆì„ìˆ˜ë¡ ë§¤ì¹­ì´ ì˜ ì´ë£¨ì–´ì¡Œë‹¤ê³  íŒë‹¨

```{r qqplot, echo = FALSE, out.height = 200, fig.cap = "fig 4. QQplot (Zhang, 2017)", fig.align='center'}
knitr::include_graphics("./fig/qqplot.jpg")
```   

]

---

.pull-left[

## .brand.blue[Jitter plot]

- $x$ì¶•ì„ ì¶”ì •ëœ PSë¡œ í•˜ëŠ” ê·¸ë¦¼

- ë§¤ì¹­ ê³¼ì •ì—ì„œ ë²„ë ¤ì§„ ìƒ˜í”Œë“¤ íŒŒì•… ê°€ëŠ¥

- ì¦‰, ë§¤ì¹­ëœ ìƒ˜í”Œì˜ ëŒ€í‘œì„±ì„ ê°€ëŠ í•´ë³¼ ìˆ˜ ìˆìŒ

```{r jitter, echo = FALSE, out.height = 250, fig.cap = "fig 5. Jitter plot (Zhang, 2017)", fig.align = "center"}
knitr::include_graphics("./fig/jitter.jpg")
```

]

.pull-right[
 
## .brand.blue[Histogram]

- $x$ì¶•ì„ ì¶”ì •ëœ PSë¡œ í•˜ëŠ” ê·¸ë¦¼

- ë§¤ì¹­ëœ ìƒ˜í”Œì—ì„œì˜ ê° êµ°ì˜ PS ë¶„í¬ê°€ ë¹„ìŠ·í•œì§€ í™•ì¸í•  ìˆ˜ ìˆìŒ

```{r hist, echo = FALSE, out.height = 350, fig.cap = "fig 6. Histogram (Zhang, 2017)", fig.align = "center"}
knitr::include_graphics("./fig/hist.jpg")
```

]

---

class: inverse, middle, center

# ì‹¤ìŠµ

---

## .brand.blue[ì›¹ì—ì„œ í•˜ëŠ” Rì„ í™œìš©í•œ PSM]

- ğŸ”—[http://web-r.org/lesson](http://web-r.org/lesson)

  - ì‚¬ì „ì— ğŸ”—[http://web-r.org](http://web-r.org/) íšŒì›ê°€ì… í•„ìš”

  - 3ë²ˆ í•­ëª© propensity score matching í´ë¦­
  
  - ğŸ”—[ìœ íŠœë¸Œ ê°•ì˜](https://www.youtube.com/watch?v=MjzX-DLB0jc&t=4s)

---

## .brand.blue[IPTW]

- ê°„ì•” í™˜ì 1128ëª…ì„ ëŒ€ìƒìœ¼ë¡œ ìƒˆë¡œìš´ ì¹˜ë£Œë²•(PBT)ê³¼ ê¸°ì¡´ ì¹˜ë£Œë²•(TACE)ì´ ì‚¬ë§ìœ¨ ë° ë³‘ì› ë‚´ ì‚¬ë§ì—¬ë¶€ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ í‰ê°€

- Confounding factor ë³´ì •ì„ ìœ„í•´ IPTW ìˆ˜í–‰

- íŒ¨í‚¤ì§€ ì„¤ì¹˜

```{r, eval = FALSE}
install.packages(c("tidyverse", "WeightIt", "survival", "cobalt"))
```

- íŒ¨í‚¤ì§€ ë¡œë”©

```{r, message = FALSE}
library(tidyverse)
library(WeightIt)
library(survival)
library(cobalt)
```

---

## .brand.blue[IPTW]

.scroll-box-20[

- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°

```{r}
dat.t <- read_csv("./data/ps_matching_dat2.csv") |> 
    janitor::clean_names()
glimpse(dat.t)
```

- Treatment: `gr`(1 = PBT, 0 = TACE)

- Response variables

  - ìƒì¡´ ìë£Œ: `death`(1 = ì‚¬ë§, 0 = ìƒì¡´), `death_yrs`(ìƒì¡´ì‹œê°„)
  - ì´ì§„í˜• ìë£Œ: `in_hospital_mortality`(1 = ì‚¬ë§, 0 = ìƒì¡´)
  
- Covariates: ê·¸ì™¸ ë³€ìˆ˜ë“¤

]

---

## .brand.blue[IPTW]

- IPTW ìˆ˜í–‰

```{r}
W1 <- weightit(gr ~ . -death-death_yrs-in_hospital_mortality, data = dat.t,
               method = "ps", estimand = "ATE",stabilize = TRUE)
dat.t$iptw2 <- W1$weights
W1
```

<!-- ATE(Average treatement effect): A êµ°ì— ëŒ€ì‘ë˜ëŠ” populationì´ Aë¥¼ ë°›ì•˜ì„ ë•Œì˜ íš¨ê³¼ì™€ A êµ°ì— ëŒ€ì‘ë˜ëŠ” populationì´ Bë¥¼ ë°›ì•˜ì„ ë•Œì˜ íš¨ê³¼ ì°¨ì´ -->

<!-- ATT(Average treatment effect on treated): ì „ì²´ population (A+B)ì´ Aë¥¼ ë°›ì•˜ì„ ë•Œì˜ íš¨ê³¼ì™€ ì „ì²´ population (A+B)ì´ Bë¥¼ ë°›ì•˜ì„ ë•Œì˜ íš¨ê³¼ ì°¨ì´ -->

<!-- ë§¤ì¹­ì€ ATTë¥¼ í†µí•´ ì¶”ì •í•˜ê³ , Weightingì€ ê³„ì‚° ë°©ì‹ì— ë”°ë¼ ATE, ATTë¥¼ ì¶”ì •í•  ìˆ˜ ìˆìŒ. ê¸°ë³¸ì€ ATEì„ -->

---

## .brand.blue[IPTW]

.scroll-output[

- Cox ph model ì í•©: ìƒˆë¡œìš´ ì¹˜ë£Œë²•ì´ ì‚¬ë§ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ í‰ê°€

```{r}
f1 <- coxph(Surv(death_yrs,death)~gr, weight=iptw2, data=dat.t)
summary(f1)
```

- ìƒˆë¡œìš´ ì¹˜ë£Œë²•ì´ ì‚¬ë§ ìœ„í—˜ì„ ì¤„ì—¬ì£¼ê¸´í•˜ë‚˜, í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•˜ë‹¤ê³  í•˜ê¸´ ì–´ë ¤ì›€( $p = 0.397$ )

]

---

## .brand.blue[IPTW]

.scroll-output[

- Logistic regression model ì í•©: ìƒˆë¡œìš´ ì¹˜ë£Œë²•ì´ ë³‘ì›ë‚´ ì‚¬ë§ì—¬ë¶€ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ í‰ê°€

```{r, warning = FALSE}
f2 <- glm(in_hospital_mortality ~ gr,weight=iptw2,data=dat.t,family=binomial)
summary(f2)
```

- ìƒˆë¡œìš´ ì¹˜ë£Œë²•ì´ ë³‘ì›ë‚´ ì‚¬ë§ì— ê´€í•œ ìƒëŒ€ ìœ„í—˜ì„ ì¤„ì—¬ì£¼ê¸´í•˜ë‚˜( ${\rm{exp}}(-0.107) = 0.899$ ), í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•˜ë‹¤ê³  í•˜ê¸´ ì–´ë ¤ì›€( $p = 0.712$ )

]

---

## .brand.blue[IPTW]

.scroll-output[

- Balance check

```{r, warning = FALSE}
bal.fit <- bal.tab(W1,stats="mean.diffs", un = TRUE, m.threshold = .2)
bal.fit
```

- ë°¸ëŸ°ì‹±ì´ ì˜ ì´ë£¨ì–´ì§

]

---

## .brand.blue[IPTW]

.scroll-output[

.pull-left[
 - Balance check ì‹œê°í™” 1

```{r, eval = FALSE}
unadj.bal <- bal.fit$Balance[2:12, 2]
adj.bal <- bal.fit$Balance[2:12, 3]
plot(c(1,2),c(-1,1),type='n',xlab='',ylab='Standardized Mean Difference',
     main='Covariate Balance',xaxt='n')
pp <- length(unadj.bal)
points(rep(1.2,pp),unadj.bal)
points(rep(1.8,pp),adj.bal)
for ( jj in 1:pp) {
    lines(c(1.2,1.8),c(unadj.bal[jj],adj.bal[jj]),type='l')
}
abline(h=0.2,col=2,lty=2)
abline(h=-0.2,col=2,lty=2)
axis(1, at=c(1.2,1.8), labels=c('Unweighted','Weighted'))
```

]

.pull-right[
```{r balance, warning = FALSE, echo = FALSE, fig.height=6.5, fig.retina = 2, fig.align = "center"}
unadj.bal <- bal.fit$Balance[2:12, 2]
adj.bal <- bal.fit$Balance[2:12, 3]
plot(c(1,2),c(-1,1),type='n',xlab='',ylab='Standardized Mean Difference',
     main='Covariate Balance',xaxt='n')
pp <- length(unadj.bal)
points(rep(1.2,pp),unadj.bal)
points(rep(1.8,pp),adj.bal)
for ( jj in 1:pp) {
    lines(c(1.2,1.8),c(unadj.bal[jj],adj.bal[jj]),type='l')
}
abline(h=0.2,col=2,lty=2)
abline(h=-0.2,col=2,lty=2)
axis(1, at=c(1.2,1.8), labels=c('Unweighted','Weighted'))
```
]

]

---

## .brand.blue[IPTW]

.pull-left[
 - Balance check ì‹œê°í™” (`age`)

```{r balance2, warning = FALSE, echo = FALSE, fig.height=6.5, fig.retina = 2, fig.align = "center"}
bal.plot(W1,"age", which = "both")
```

]

.pull-right[
 - Balance check ì‹œê°í™” (`dm`: ë‹¹ë‡¨ ìœ ë¬´)

```{r balance3, warning = FALSE, echo = FALSE, fig.height=6.5, fig.retina = 2, fig.align = "center"}
bal.plot(W1,"dm", which = "both")
```
]


---


## .brand.blue[ì±… ì¶”ì²œ]

- ğŸ”—[R ê¸°ë°˜ ì„±í–¥ì ìˆ˜ë¶„ì„](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9788955662450)

- ğŸ”—[í†µê³„ì  ì¸ê³¼ ì¶”ë¡ (ê°œì •íŒ)](https://www.kyowoo.co.kr/02_sub/view.php?p_idx=1640&cate=0014_0019_)

---
class: inverse, middle, center

# References

---

## .brand.blue[References]

.scroll-output[

[1] Karavani, Ehud. â€œSolving Simpsonâ€™s Paradox with Inverse Probability Weighting.â€ Medium, September 12, 2020. https://towardsdatascience.com/solving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597.

[2] Kim, Jinsil. â€œRWE ì—°êµ¬ì—ì„œ ì¸ê³¼ì¶”ë¡ .â€ Linewalks Blog (blog), February 2, 2021. https://blog.linewalks.com/archives/7335.

[3] Lee, Dong Kyu. â€œAn Introduction to Propensity Score Matching Methods.â€ Anesthesia and Pain Medicine 11, no. 2 (April 30, 2016): 130â€“48. https://doi.org/10.17085/apm.2016.11.2.130.

[4] web-r. WebrPSM, 2021. https://www.youtube.com/watch?v=MjzX-DLB0jc.

[5] Zhang, Zhongheng. â€œPropensity Score Method: A Non-Parametric Technique to Reduce Model Dependence.â€ Annals of Translational Medicine 5 (January 1, 2017): 7â€“7. https://doi.org/10.21037/atm.2016.08.57.

[6] ì¸ê³¼ì¶”ë¡ ì˜ ë°ì´í„°ê³¼í•™. [Bootcamp 2-4] ë§¤ì¹­ê³¼ ì—­í™•ë¥ ê°€ì¤‘ì¹˜, 2022. https://www.youtube.com/watch?v=BVBUQz3Ix8w.

]

---

class: inverse

# Thanks!

.pull-right[.pull-down[

<a href="mailto:favorite@kakao.com">
.white[`r icons::fontawesome("paper-plane")` favorite@kakao.com]
</a>

<a href="https://github.com/be-favorite">
.white[`r icons::fontawesome("github")` @be-favorite]
</a>

<a href="https://twitter.com/TaemoBang">
.white[`r icons::fontawesome("twitter")` @TaemoBang]
</a>

<a href="https://github.com/be-favorite/Presentation_archive">
.white[`r icons::fontawesome("link")` Presentation archive]
</a>

<br><br><br>

]]
